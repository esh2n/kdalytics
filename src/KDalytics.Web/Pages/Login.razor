@page "/login"
@using KDalytics.Web.Models
@using KDalytics.Web.Services
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>KDalytics - Discordã§ãƒ­ã‚°ã‚¤ãƒ³</PageTitle>

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <h1>KDalytics</h1>
            <p>Valorant æˆ¦ç¸¾ãƒˆãƒ©ãƒƒã‚«ãƒ¼ + Discordé€£æº</p>
        </div>

        <div class="login-body">
            <div class="text-center mb-4">
                <img src="images/valorant-logo.png" alt="Valorant Logo" class="login-logo"
                    onerror="this.src='images/placeholder.png'; this.onerror=null;" />
            </div>

            <p class="text-center mb-4">
                Discordã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã€ã‚µãƒ¼ãƒãƒ¼ã®æˆ¦ç¸¾ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã—ã‚‡ã†ã€‚
            </p>

            <button class="discord-button" @onclick="LoginWithDiscord">
                <span>ğŸ”—</span> Discordã§ãƒ­ã‚°ã‚¤ãƒ³
            </button>
        </div>

        <div class="login-footer">
            <p class="text-sm text-gray mb-0">
                ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ã§ã€KDalyticsã®<a href="/terms">åˆ©ç”¨è¦ç´„</a>ã¨<a href="/privacy">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>ã«åŒæ„ã—ãŸã“ã¨ã«ãªã‚Šã¾ã™ã€‚
            </p>
        </div>
    </div>
</div>

@code {
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        // ã™ã§ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        var token = await GetStoredTokenAsync();
        if (!string.IsNullOrEmpty(token))
        {
            // ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼
            if (await ValidateTokenAsync(token))
            {
                // èªè¨¼æˆåŠŸã€ã‚µãƒ¼ãƒãƒ¼ä¸€è¦§ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                NavigateToServers();
            }
        }
    }

    private async Task LoginWithDiscord()
    {
        try
        {
            // Discordèªè¨¼ãƒšãƒ¼ã‚¸ã‚’é–‹ã
            await JSRuntime.InvokeVoidAsync("openDiscordAuth");
        }
        catch (Exception ex)
        {
            _error = $"ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {ex.Message}";
        }
    }

    private void NavigateToServers()
    {
        NavigationManager.NavigateTo("/servers");
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    private async Task<string> GetStoredTokenAsync()
    {
        try
        {
            return await JSRuntime.InvokeAsync<string>("localStorageHelper.getItem", "kdalytics_auth_token") ?? "";
        }
        catch
        {
            return "";
        }
    }

    // ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯APIã‚’å‘¼ã³å‡ºã—ã¦æ¤œè¨¼ã™ã‚‹ï¼‰
    private async Task<bool> ValidateTokenAsync(string token)
    {
        // TODO: å®Ÿéš›ã«ã¯APIã‚’å‘¼ã³å‡ºã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã™ã‚‹
        // ç¾åœ¨ã¯ãƒ¢ãƒƒã‚¯ã®æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯
        await Task.Delay(500); // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        return !string.IsNullOrEmpty(token);
    }
}

<style>
    .login-logo {
        max-width: 120px;
        margin-bottom: 1.5rem;
    }
</style>